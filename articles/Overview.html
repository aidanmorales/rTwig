<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Overview • rTwig</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Overview">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rTwig</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Box-Dimension.html">Box-Dimension</a></li>
    <li><a class="dropdown-item" href="../articles/Dictionary.html">Dictionary</a></li>
    <li><a class="dropdown-item" href="../articles/Metrics.html">Metrics</a></li>
    <li><a class="dropdown-item" href="../articles/Overview.html">Overview</a></li>
    <li><a class="dropdown-item" href="../articles/Twigs.html">Twigs</a></li>
    <li><a class="dropdown-item" href="../articles/Validation.html">Validation</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/aidanmorales/rTwig/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Overview</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/aidanmorales/rTwig/blob/main/vignettes/Overview.Rmd" class="external-link"><code>vignettes/Overview.Rmd</code></a></small>
      <div class="d-none name"><code>Overview.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>Real Twig was designed and tested using QSMs created with the <a href="https://github.com/InverseTampere/TreeQSM" class="external-link">TreeQSM</a> modeling
software. If high quality point clouds, QSMs with the proper input
settings, and species specific twig diameter measurements are supplied,
you can expect to get very good estimates of tree volume within ± 10% of
the real tree volume.</p>
<p>If any given QSM provides parent-child cylinder relationships, Real
Twig will work, as is the case of the <a href="https://www.simpleforest.org/" class="external-link">SimpleForest</a>, <a href="https://github.com/wanxinyang/treegraph/tree/master" class="external-link">Treegraph</a>,
and <a href="https://github.com/umr-amap/aRchi" class="external-link">aRchi</a> software
packages. If high quality point clouds, QSMs with the proper input
settings, and species specific twig diameter measurements are supplied,
you can expect to get good estimates of tree volume across multiple
different software packages.</p>
<p>While Real Twig can provide excellent tree volume estimates, it can
not transform poor quality data into good data. As a general rule of
thumb, the closer the QSM resembles the actual tree before correction,
the better the results will be after correction. Real Twig performs best
when the topology of the tree is correct, and only the cylinder sizes
are the main sources of QSM error. Errors in QSM topology become readily
apparent after correction, so Real Twig can also be used to visually
validate QSM topology without reference data.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install the package directly from <a href="https://CRAN.R-project.org" class="external-link">CRAN</a>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"rTwig"</span><span class="op">)</span></span></code></pre></div>
<p>Or the latest development version from <a href="https://github.com/" class="external-link">GitHub</a>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"https://github.com/aidanmorales/rTwig"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="load-packages">Load Packages<a class="anchor" aria-label="anchor" href="#load-packages"></a>
</h2>
<p>The first step is to load the rTwig package. Real Twig works well
when paired with packages from the <a href="https://www.tidyverse.org/" class="external-link">Tidyverse</a>, so we will also load
the dplyr package to help with data manipulation.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load rTwig</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://aidanmorales.github.io/rTwig/">rTwig</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Other useful packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="import-qsm">Import QSM<a class="anchor" aria-label="anchor" href="#import-qsm"></a>
</h2>
<p>rTwig supports all available versions of TreeQSM, from <em>v2.0</em>
to <em>v2.4.1</em> at the time of writing. It is important to note that
legacy versions of TreeQSM (<em>v2.0</em>) store data in a much
different format than modern versions (<em>v2.3.0-2.4.1</em>). It is
strongly advised to use the latest version of TreeQSM with rTwig for the
best QSM topology and volume estimates. Older versions can be used, but
the QSM topology is poor, and volume underestimation is almost
guaranteed.</p>
<p>Regardless of the version of TreeQSM or MATLAB used, the
<code><a href="../reference/import_qsm.html">import_qsm()</a></code> function will import a QSM (.mat extension)
and convert the data to a format usable by R. The user must specify
which version of TreeQSM they are using with the <code>version</code>
parameter. rTwig automatically defaults to use the new TreeQSM format,
so the older format can be imported with <code>version = "2.0"</code>.
<code><a href="../reference/import_qsm.html">import_qsm()</a></code> also imports all QSM information, including
cylinder, branch, treedata, rundata, pmdistance, and triangulation data,
which are stored together as a list.</p>
<p>SimpleForest exports its QSMs as .csv files, so they are easy to load
into R using the built in <code><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv()</a></code> function. If the QSM
contains thousands of cylinders, it is much faster to use the
<code>fread()</code> function from the <code>data.table</code> package
to take advantage of multi-threaded support.</p>
<p>Treegraph exports its QSMs as .json files. To import them into R, we
can use the <code><a href="../reference/import_treegraph.html">import_treegraph()</a></code> function to quickly load in
a Treegraph QSM.</p>
<p>aRchi is built in R, so there is no provided function to import the
data. Users can extract the aRchi cylinder data with
<code>aRchi::get_QSM()</code> before running the rTwig functions.</p>
<div class="section level4">
<h4 id="example-1-treeqsm-v2-3-0---2-4-1">Example 1: TreeQSM v2.3.0 - 2.4.1<a class="anchor" aria-label="anchor" href="#example-1-treeqsm-v2-3-0---2-4-1"></a>
</h4>
<p>We can import a QSM by supplying the <code><a href="../reference/import_qsm.html">import_qsm()</a></code>
function the directory to our QSM.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># QSM directory</span></span>
<span><span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/QSM.mat"</span>, package <span class="op">=</span> <span class="st">"rTwig"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Import and save QSM</span></span>
<span><span class="va">qsm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/import_qsm.html">import_qsm</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span></span></code></pre></div>
<p>The QSM should be a list with six elements. We can check it as
follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">qsm</span><span class="op">)</span></span>
<span><span class="co">#&gt;               Length Class      Mode</span></span>
<span><span class="co">#&gt; cylinder      17     data.frame list</span></span>
<span><span class="co">#&gt; branch        10     data.frame list</span></span>
<span><span class="co">#&gt; treedata      91     -none-     list</span></span>
<span><span class="co">#&gt; rundata       45     data.frame list</span></span>
<span><span class="co">#&gt; pmdistance    21     -none-     list</span></span>
<span><span class="co">#&gt; triangulation 12     -none-     list</span></span></code></pre></div>
<p>Let’s check what version of TreeQSM was used, the date the QSM was
made, and take a look at the cylinder data.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># QSM info</span></span>
<span><span class="va">qsm</span><span class="op">$</span><span class="va">rundata</span><span class="op">$</span><span class="va">version</span></span>
<span><span class="co">#&gt; [1] "2.4.1"</span></span>
<span><span class="va">qsm</span><span class="op">$</span><span class="va">rundata</span><span class="op">$</span><span class="va">start.date</span></span>
<span><span class="co">#&gt; [1] "2023-12-06 10:14:31 UTC"</span></span>
<span></span>
<span><span class="co"># Number of cylinders</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">qsm</span><span class="op">$</span><span class="va">cylinder</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    1136 obs. of  17 variables:</span></span>
<span><span class="co">#&gt;  $ radius          : num  0.0465 0.0454 0.0442 0.0437 0.0429 ...</span></span>
<span><span class="co">#&gt;  $ length          : num  0.09392 0.07216 0.06654 0.00938 0.06795 ...</span></span>
<span><span class="co">#&gt;  $ start.x         : num  0.768 0.768 0.768 0.769 0.769 ...</span></span>
<span><span class="co">#&gt;  $ start.y         : num  -16.4 -16.4 -16.4 -16.3 -16.3 ...</span></span>
<span><span class="co">#&gt;  $ start.z         : num  254 254 254 254 254 ...</span></span>
<span><span class="co">#&gt;  $ axis.x          : num  0.00995 -0.0111 0.01364 0.01571 0.01449 ...</span></span>
<span><span class="co">#&gt;  $ axis.y          : num  0.0912 0.0391 0.0367 0.0271 0.0267 ...</span></span>
<span><span class="co">#&gt;  $ axis.z          : num  0.996 0.999 0.999 1 1 ...</span></span>
<span><span class="co">#&gt;  $ parent          : int  0 1 2 3 4 5 6 7 8 9 ...</span></span>
<span><span class="co">#&gt;  $ extension       : int  2 3 4 5 6 7 8 9 10 11 ...</span></span>
<span><span class="co">#&gt;  $ added           : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ UnmodRadius     : num  0.0465 0.0454 0.0442 0.0437 0.0429 ...</span></span>
<span><span class="co">#&gt;  $ branch          : int  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ SurfCov         : num  0.875 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ mad             : num  0.00072 0.000538 0.000523 0.000335 0.000438 ...</span></span>
<span><span class="co">#&gt;  $ BranchOrder     : int  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ PositionInBranch: int  1 2 3 4 5 6 7 8 9 10 ...</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="example-2-treeqsm-v2-0">Example 2: TreeQSM v2.0<a class="anchor" aria-label="anchor" href="#example-2-treeqsm-v2-0"></a>
</h4>
<p>Let’s try importing an old QSM and check its structure.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># QSM Directory</span></span>
<span><span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/QSM_2.mat"</span>, package <span class="op">=</span> <span class="st">"rTwig"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Import and save QSM</span></span>
<span><span class="va">qsm2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/import_qsm.html">import_qsm</a></span><span class="op">(</span><span class="va">file</span>, version <span class="op">=</span> <span class="st">"2.0"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># QSM Info</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">qsm2</span><span class="op">)</span></span>
<span><span class="co">#&gt;          Length Class      Mode</span></span>
<span><span class="co">#&gt; cylinder 15     data.frame list</span></span>
<span><span class="co">#&gt; treedata 33     -none-     list</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">qsm2</span><span class="op">$</span><span class="va">cylinder</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    1026 obs. of  15 variables:</span></span>
<span><span class="co">#&gt;  $ radius          : num  0.0612 0.056 0.0553 0.0552 0.0534 ...</span></span>
<span><span class="co">#&gt;  $ length          : num  0.335 0.283 0.272 0.244 0.267 ...</span></span>
<span><span class="co">#&gt;  $ start.x         : num  8.4 8.43 8.44 8.47 8.5 ...</span></span>
<span><span class="co">#&gt;  $ start.y         : num  47.7 47.7 47.7 47.8 47.8 ...</span></span>
<span><span class="co">#&gt;  $ start.z         : num  2.23 2.57 2.85 3.12 3.36 ...</span></span>
<span><span class="co">#&gt;  $ axis.x          : num  0.1103 0.0531 0.0878 0.1666 0.0894 ...</span></span>
<span><span class="co">#&gt;  $ axis.y          : num  0.0337 0.0296 0.1282 0.0801 0.061 ...</span></span>
<span><span class="co">#&gt;  $ axis.z          : num  0.993 0.998 0.988 0.983 0.994 ...</span></span>
<span><span class="co">#&gt;  $ parent          : num  0 1 2 3 4 5 6 7 8 9 ...</span></span>
<span><span class="co">#&gt;  $ extension       : num  1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span><span class="co">#&gt;  $ added           : int  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ UnmodRadius     : num  0.0612 0.056 0.0553 0.0552 0.0534 ...</span></span>
<span><span class="co">#&gt;  $ branch          : num  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ BranchOrder     : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ PositionInBranch: num  1 2 3 4 5 6 7 8 9 10 ...</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="example-3-simpleforest">Example 3: SimpleForest<a class="anchor" aria-label="anchor" href="#example-3-simpleforest"></a>
</h4>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># QSM directory</span></span>
<span><span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/QSM.csv"</span>, package <span class="op">=</span> <span class="st">"rTwig"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Import and save QSM cylinder data</span></span>
<span><span class="va">cylinder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span></span></code></pre></div>
<p>Let’s take a look at the SimpleForest cylinder data.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">cylinder</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    1149 obs. of  17 variables:</span></span>
<span><span class="co">#&gt;  $ ID                  : int  0 1 2 3 4 5 6 7 8 9 ...</span></span>
<span><span class="co">#&gt;  $ parentID            : int  -1 0 1 2 3 4 5 6 7 8 ...</span></span>
<span><span class="co">#&gt;  $ startX              : num  0.761 0.759 0.771 0.768 0.765 ...</span></span>
<span><span class="co">#&gt;  $ startY              : num  -16.4 -16.4 -16.4 -16.3 -16.4 ...</span></span>
<span><span class="co">#&gt;  $ startZ              : num  254 254 254 254 254 ...</span></span>
<span><span class="co">#&gt;  $ endX                : num  0.759 0.771 0.768 0.765 0.769 ...</span></span>
<span><span class="co">#&gt;  $ endY                : num  -16.4 -16.4 -16.3 -16.4 -16.4 ...</span></span>
<span><span class="co">#&gt;  $ endZ                : num  254 254 254 254 254 ...</span></span>
<span><span class="co">#&gt;  $ radius              : num  0.0472 0.0479 0.0469 0.0467 0.0453 ...</span></span>
<span><span class="co">#&gt;  $ length              : num  0.0497 0.0529 0.0535 0.0525 0.0528 ...</span></span>
<span><span class="co">#&gt;  $ growthLength        : num  31.4 31.4 31.3 31.3 31.2 ...</span></span>
<span><span class="co">#&gt;  $ averagePointDistance: num  0.00589 0.00378 0.00205 0.00246 0.00251 ...</span></span>
<span><span class="co">#&gt;  $ segmentID           : int  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ parentSegmentID     : int  -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...</span></span>
<span><span class="co">#&gt;  $ branchOrder         : int  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ reverseBranchOrder  : int  18 18 18 18 18 18 18 18 18 18 ...</span></span>
<span><span class="co">#&gt;  $ branchID            : int  0 0 0 0 0 0 0 0 0 0 ...</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="cylinder-data">Cylinder Data<a class="anchor" aria-label="anchor" href="#cylinder-data"></a>
</h2>
<p>Next, we have to update the parent-child ordering in the cylinder
data to allow for path analysis and add some new QSM variables. The most
important QSM variable is growth length. Growth length is a cumulative
length metric, where the growth length of a cylinder is its length, plus
the lengths of all of its children. This gives us perfect ordering along
a branch or a path, where the highest growth length is equal to the base
of the tree, and twigs have a growth length equal to their cylinder
length. It is also important to note that the number of twigs in a QSM
is always equal to the number of paths in a QSM, since a path goes from
the base of the tree to a twig tip.</p>
<p>We also calculate several additional variables to improve QSM
analysis and visualization. The reverse branch order (RBO) assigns an
order of 1 to the twigs, and works backwards to the base of the main
stem, which has the highest RBO. The RBO is essentially the maximum node
depth for any given branch segment (the area between branching forks).
RBO problematic twig cylinders easy to identify. The distance from each
cylinder to the base, and the average distance from each cylinder to all
supported twigs are new ways to help visualize problematic
cylinders.</p>
<p>Let’s save the cylinders to a new variable to make it easier to work
with and update the ordering.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Save cylinders to new object</span></span>
<span><span class="va">cylinder</span> <span class="op">&lt;-</span> <span class="va">qsm</span><span class="op">$</span><span class="va">cylinder</span></span>
<span></span>
<span><span class="co"># Update cylinder data</span></span>
<span><span class="va">cylinder</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_cylinders.html">update_cylinders</a></span><span class="op">(</span><span class="va">cylinder</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="topology">Topology<a class="anchor" aria-label="anchor" href="#topology"></a>
</h2>
<p>Before we correct the QSM, it is often worthwhile to check the
quality of the QSM by plotting it against its input point cloud. To do
this, we load the point cloud and save it as a data frame, with the
first three columns as the x, y, and z columns. We use the
<code><a href="../reference/plot_qsm.html">plot_qsm()</a></code> function to do this. We want to check the raw
cylinder fits before any possible modification, so we will will use the
raw cylinder radii.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the input point cloud</span></span>
<span><span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/cloud.txt"</span>, package <span class="op">=</span> <span class="st">"rTwig"</span><span class="op">)</span></span>
<span><span class="va">cloud</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="va">file</span>, header <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the qsm and point cloud</span></span>
<span><span class="fu"><a href="../reference/plot_qsm.html">plot_qsm</a></span><span class="op">(</span>cylinder <span class="op">=</span> <span class="va">cylinder</span>, cloud <span class="op">=</span> <span class="va">cloud</span>, radius <span class="op">=</span> <span class="st">"UnmodRadius"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="twig-diameters">Twig Diameters<a class="anchor" aria-label="anchor" href="#twig-diameters"></a>
</h2>
<p>Before we can correct the QSM radii, we need to know what our real
twig diameter is. For this example tree, the species is a Kentucky
coffee tree (<em>Gymnocladus dioicus</em>), which has nice, stout twigs.
rTwig comes with a data base of twigs that can be called by typing in
the <code>twigs</code> data set. The data set includes the average twig
radius, the min and max radius, the standard deviation, and the
coefficient of variation. Let’s look at the twig data set and find the
twig diameter for Kentucky coffee tree.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Look at the twigs database</span></span>
<span><span class="va">twigs</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 104 × 7</span></span></span>
<span><span class="co">#&gt;    scientific_name  radius_mm     n   min   max   std    cv</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Abies concolor        1.43    21  0.89  1.9   0.28  0.19</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Abies spp.            1.43    21  0.89  1.9   0.28  0.19</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Acer platanoides      1.39    30  0.89  2.03  0.3   0.21</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Acer rubrum           1.18    30  0.89  1.52  0.16  0.14</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Acer saccharinum      1.41    14  0.89  1.9   0.27  0.2 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Acer saccharum        1.2     30  0.89  1.65  0.23  0.19</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Acer spp.             1.29   104  0.89  2.03  0.23  0.18</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Aesculus flava        2.96    14  2.29  4.44  0.58  0.19</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Aesculus spp.         2.96    14  2.29  4.44  0.58  0.19</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Betula nigra          0.85    30  0.51  1.52  0.23  0.27</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 94 more rows</span></span></span>
<span></span>
<span><span class="co"># Find our species</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">twigs</span>, <span class="va">scientific_name</span> <span class="op">==</span> <span class="st">"Gymnocladus dioicus"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 7</span></span></span>
<span><span class="co">#&gt;   scientific_name     radius_mm     n   min   max   std    cv</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Gymnocladus dioicus      4.23    30  2.79   6.6  0.87   0.2</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="summary-metrics">Summary Metrics<a class="anchor" aria-label="anchor" href="#summary-metrics"></a>
</h2>
<p>Before we correct the QSM, Let’s take a look at the current metrics,
so we can compare the tree volume before and after correction. We can do
this with the <code><a href="../reference/qsm_summary.html">qsm_summary()</a></code> function. If stem triangulation
was enabled in TreeQSM, we can use it to better represent the main stem
volume in some cases, especially when there are large buttress flares.
We can also make a plot of the radius versus the growth length to see
how much overestimation there is in the twig radii.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># QSM summary</span></span>
<span><span class="fu"><a href="../reference/qsm_summary.html">qsm_summary</a></span><span class="op">(</span>cylinder <span class="op">=</span> <span class="va">cylinder</span>, radius <span class="op">=</span> <span class="va">radius</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tidytable: 6 × 3</span></span></span>
<span><span class="co">#&gt;   branch_order tree_volume_L tree_area_m2</span></span>
<span><span class="co">#&gt;          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>            0       10.8         0.644  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>            1        5.80        0.827  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>            2        3.86        0.732  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>            3        1.06        0.237  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>            4        0.622       0.078<span style="text-decoration: underline;">5</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>            5        0.034<span style="text-decoration: underline;">6</span>      0.006<span style="text-decoration: underline;">93</span></span></span>
<span></span>
<span><span class="co"># QSM summary with Triangulation</span></span>
<span><span class="fu"><a href="../reference/qsm_summary.html">qsm_summary</a></span><span class="op">(</span>cylinder <span class="op">=</span> <span class="va">cylinder</span>, radius <span class="op">=</span> <span class="va">radius</span>, triangulation <span class="op">=</span> <span class="va">qsm</span><span class="op">$</span><span class="va">triangulation</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tidytable: 6 × 3</span></span></span>
<span><span class="co">#&gt;   branch_order tree_volume_L tree_area_m2</span></span>
<span><span class="co">#&gt;          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>            0       28.7         0.632  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>            1        5.80        0.827  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>            2        3.86        0.732  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>            3        1.06        0.237  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>            4        0.622       0.078<span style="text-decoration: underline;">5</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>            5        0.034<span style="text-decoration: underline;">6</span>      0.006<span style="text-decoration: underline;">93</span></span></span></code></pre></div>
<p><img src="Overview_files/figure-html/unnamed-chunk-16-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Looking at the diagnostic plot on a log log scale, with the measured
twig radius as the horizontal line, we can see that nearly all of the
twig radii are overestimated, with increasing radii variation as the
growth length approaches zero. Except for the main stem, there is not a
very clear pattern in the individual branch tapering.</p>
</div>
<div class="section level2">
<h2 id="correct-radii">Correct Radii<a class="anchor" aria-label="anchor" href="#correct-radii"></a>
</h2>
<p>Now we can correct our QSM cylinder radii with the
<code><a href="../reference/correct_radii.html">correct_radii()</a></code> function. In this step, we model each path
in the tree separately, where poorly fit cylinders are identified and
removed, and a GAM is fit, where the intercept is the measured twig
radius, and the growth length predicts the cylinder radius. Let’s
correct the cylinder radii on our Kentucky coffee tree and look at the
new volume estimates and diagnostic plots.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Correct cylinder radii</span></span>
<span><span class="va">cylinder</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/correct_radii.html">correct_radii</a></span><span class="op">(</span><span class="va">cylinder</span>, twig_radius <span class="op">=</span> <span class="fl">4.23</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Corrected QSM summary</span></span>
<span><span class="fu"><a href="../reference/qsm_summary.html">qsm_summary</a></span><span class="op">(</span><span class="va">cylinder</span>, radius <span class="op">=</span> <span class="va">radius</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tidytable: 6 × 3</span></span></span>
<span><span class="co">#&gt;   branch_order tree_volume_L tree_area_m2</span></span>
<span><span class="co">#&gt;          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>            0      10.8          0.640  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>            1       5.20         0.754  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>            2       2.69         0.583  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>            3       0.539        0.170  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>            4       0.104        0.043<span style="text-decoration: underline;">1</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>            5       0.006<span style="text-decoration: underline;">83</span>      0.003<span style="text-decoration: underline;">08</span></span></span></code></pre></div>
<p><img src="Overview_files/figure-html/unnamed-chunk-18-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Here we can see that we reduced the volume of the QSM by around 3
liters, which is around a 15% overestimation in volume before
correction. Kentucky coffee tree has relatively large twigs, so the
overestimation is not as severe as a tree with much smaller twigs, that
can have upwards of &gt;200% overestimation in some cases.</p>
<p>Looking at the diagnostic plot, we can see that individual branches
can clearly be identified by their unique allometry. Notice how nearly
all of the volume reduction occurred in the higher order branches, with
the main stem remaining nearly unchanged. The branches now taper towards
the measured twig radius for Kentucky coffee tree. Getting the real twig
diameter is critical, as too high a value will overestimate volume, and
too low a value will underestimate total volume, with the over or
underestimate being proportional to the number of twigs and small
branches in the tree. If your species is not available in the database,
we have found that the genus level twig radius average is a good
substitute.</p>
</div>
<div class="section level2">
<h2 id="visualization">Visualization<a class="anchor" aria-label="anchor" href="#visualization"></a>
</h2>
<p>Optionally, we can smooth our QSM by ensuring all of the cylinders
are connected. This is a visual change and does not affect the volume
estimates. We can do this with the <code><a href="../reference/smooth_qsm.html">smooth_qsm()</a></code> function,
and plot the results with the <code><a href="../reference/plot_qsm.html">plot_qsm()</a></code> function. The
different colors are the different branch orders. We can also color our
QSM by many different variables and palettes. See the
<code><a href="../reference/plot_qsm.html">plot_qsm()</a></code> documentation for more details.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Smooth QSM</span></span>
<span><span class="va">cylinder</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smooth_qsm.html">smooth_qsm</a></span><span class="op">(</span><span class="va">cylinder</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot QSM</span></span>
<span><span class="fu"><a href="../reference/plot_qsm.html">plot_qsm</a></span><span class="op">(</span><span class="va">cylinder</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># QSM Custom Colors &amp; Piping</span></span>
<span><span class="va">cylinder</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/plot_qsm.html">plot_qsm</a></span><span class="op">(</span></span>
<span>    radius <span class="op">=</span> <span class="st">"radius"</span>,</span>
<span>    cyl_color <span class="op">=</span> <span class="st">"reverseBranchOrder"</span>,</span>
<span>    cyl_palette <span class="op">=</span> <span class="st">"magma"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot Twigs Colored by Unique Segment</span></span>
<span><span class="va">cylinder</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">reverseBranchOrder</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/plot_qsm.html">plot_qsm</a></span><span class="op">(</span></span>
<span>    radius <span class="op">=</span> <span class="st">"radius"</span>,</span>
<span>    cyl_color <span class="op">=</span> <span class="st">"reverseBranchOrder"</span>,</span>
<span>    cyl_palette <span class="op">=</span> <span class="st">"rainbow"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We can also save our QSM as a mesh (.ply extension) for use in other
modeling programs with the <code><a href="../reference/export_mesh.html">export_mesh()</a></code> function. The same
colors and palettes found in the <code><a href="../reference/plot_qsm.html">plot_qsm()</a></code> function can be
used to color the mesh.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Export Mesh Colored by RBO</span></span>
<span><span class="va">cylinder</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/export_mesh.html">export_mesh</a></span><span class="op">(</span></span>
<span>    filename <span class="op">=</span> <span class="st">"QSM_mesh"</span>,</span>
<span>    radius <span class="op">=</span> <span class="st">"radius"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"reverseBranchOrder"</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"magma"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Export Twigs Colored by Unique Segments</span></span>
<span><span class="va">cylinder</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">reverseBranchOrder</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/export_mesh.html">export_mesh</a></span><span class="op">(</span></span>
<span>    filename <span class="op">=</span> <span class="st">"QSM_mesh"</span>,</span>
<span>    radius <span class="op">=</span> <span class="st">"radius"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"reverseBranchOrder"</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"rainbow"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="workflow-best-practices">Workflow &amp; Best Practices<a class="anchor" aria-label="anchor" href="#workflow-best-practices"></a>
</h2>
<p>Below is an overview of the typical rTwig processing chain. When
dealing with multiple trees, we advise creating a master data frame in a
tidy format, where each unique tree is a row, and the columns are the
tree id, the directory to the QSM .mat file, and the species twig
diameter, all of which can be tailored to your workflow needs. Then it
is a simple matter of looping over the master data frame, correcting
each tree, and saving the results to a master list. Make sure to read
each function’s documentation for more examples and unique features.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import QSM</span></span>
<span><span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/QSM.mat"</span>, package <span class="op">=</span> <span class="st">"rTwig"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Real Twig Main Steps</span></span>
<span><span class="va">cylinder</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_rtwig.html">run_rtwig</a></span><span class="op">(</span><span class="va">file</span>, twig_radius <span class="op">=</span> <span class="fl">4.23</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Tree Metrics</span></span>
<span><span class="va">metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tree_metrics.html">tree_metrics</a></span><span class="op">(</span><span class="va">cylinder</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot Results</span></span>
<span><span class="fu"><a href="../reference/plot_qsm.html">plot_qsm</a></span><span class="op">(</span><span class="va">cylinder</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Aidan Morales, David W. MacFarlane.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
